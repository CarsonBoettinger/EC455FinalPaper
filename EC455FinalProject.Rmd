---
title: "EC455 Final Project"
author: "Carson Boettinger and Nithin Kumar"
date: '`r Sys.Date()`'
output: html_document
---

```{r}
#Importing the libraries
library(tidyverse)  # Data manipulation and visualization
library(tseries)    # Time series analysis
library(urca)       # Unit root and cointegration analysis
library(vars)       # Vector autoregression models
library(lmtest)     # Diagnostic testing
library(forecast)   # Time series forecasting
library(xts)        # Extensible time series
library(ggplot2)    # Enhanced visualization
library(corrplot)   # Correlation plots
library(gridExtra)  # Arranging multiple plots
library(lubridate)
library(dplyr)
library(tidyr)
```

```{r setup, include=FALSE}
coffee <- read.csv("CommodityEC455/coffee-prices-historical-chart-data.csv")
copper <- read.csv("CommodityEC455/copper-prices-historical-chart-data.csv")
corn <- read.csv("CommodityEC455/corn-prices-historical-chart-data.csv")
cotton <- read.csv("CommodityEC455/cotton-prices-historical-chart-data.csv")
lumber <- read.csv("CommodityEC455/lumber-prices-historical-chart-data.csv")
oats <- read.csv("CommodityEC455/oats-prices-historical-chart-data.csv")
soybean <- read.csv("CommodityEC455/soybean-prices-historical-chart-data.csv")
wheat <- read.csv("CommodityEC455/wheat-prices-historical-chart-data.csv")
```

```{r}
head(coffee)
```



```{r}
# Load required libraries
library(lubridate)

# Function to filter data for a specific date range
filter_date_range <- function(data, start_date, end_date) {
  # Convert date column from character to Date format
  # The column appears to already be in YYYY-MM-DD format
  data$date <- ymd(data$date)  
  
  # Filter data for dates between start_date and end_date (inclusive)
  filtered_data <- data[data$date >= start_date & data$date <= end_date, ]
  
  return(filtered_data)
}

# Define start and end dates using the same format
start_date <- ymd("1980-01-01")
end_date <- ymd("2019-01-01")

# Filter each commodity dataset
coffee_filtered <- filter_date_range(coffee, start_date, end_date)
copper_filtered <- filter_date_range(copper, start_date, end_date)
corn_filtered <- filter_date_range(corn, start_date, end_date)
cotton_filtered <- filter_date_range(cotton, start_date, end_date)
lumber_filtered <- filter_date_range(lumber, start_date, end_date)
oats_filtered <- filter_date_range(oats, start_date, end_date)
soybean_filtered <- filter_date_range(soybean, start_date, end_date)
wheat_filtered <- filter_date_range(wheat, start_date, end_date)

# Check the date range of the filtered data
print(paste("Coffee date range:", min(coffee_filtered$date), "to", max(coffee_filtered$date)))
```

```{r}
print(head(coffee_filtered))
print(str(coffee))
```

Visualization and detrending each series
```{r}

# Part 1: Visualizing original time series for each commodity
# Function to create time series plot
plot_commodity <- function(data, commodity_name, color) {
  p <- ggplot(data, aes(x = date, y = value)) +
    geom_line(color = color) +
    theme_minimal() +
    labs(title = paste(commodity_name, "Prices (1980-2019)"),
         x = "Year", 
         y = "Price") +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"))
  return(p)
}

# Create plots for each commodity
coffee_plot <- plot_commodity(coffee_filtered, "Coffee", "brown")
copper_plot <- plot_commodity(copper_filtered, "Copper", "orange")
corn_plot <- plot_commodity(corn_filtered, "Corn", "yellow4")
cotton_plot <- plot_commodity(cotton_filtered, "Cotton", "skyblue")
lumber_plot <- plot_commodity(lumber_filtered, "Lumber", "darkgreen")
oats_plot <- plot_commodity(oats_filtered, "Oats", "tan4")
soybean_plot <- plot_commodity(soybean_filtered, "Soybean", "green")
wheat_plot <- plot_commodity(wheat_filtered, "Wheat", "gold")

# Display plots in a 4x2 grid
grid.arrange(coffee_plot, copper_plot, corn_plot, cotton_plot,
             lumber_plot, oats_plot, soybean_plot, wheat_plot,
             ncol = 2)

```
```{r}
# Part 2: Series Transformations
# Function to transform time series data
transform_series <- function(data) {
  # Create a copy to avoid changing the original
  transformed <- data
  
  # Log transformation
  transformed$log_value <- log(transformed$value)
  
  # First difference
  transformed$diff_value <- c(NA, diff(transformed$value))
  
  # Log first difference (difference of log values)
  transformed$log_diff_value <- c(NA, diff(transformed$log_value))
  
  return(transformed)
}


# Apply transformations to each commodity dataset
coffee_trans <- transform_series(coffee_filtered)
copper_trans <- transform_series(copper_filtered)
corn_trans <- transform_series(corn_filtered)
cotton_trans <- transform_series(cotton_filtered)
lumber_trans <- transform_series(lumber_filtered)
oats_trans <- transform_series(oats_filtered)
soybean_trans <- transform_series(soybean_filtered)
wheat_trans <- transform_series(wheat_filtered)

# Function to plot the original and transformed series for a commodity
plot_transformations <- function(data, commodity_name) {
  # Original series
  p1 <- ggplot(data, aes(x = date, y = value)) +
    geom_line(color = "black") +
    theme_minimal() +
    labs(title = paste(commodity_name, "- Original Series"),
         x = "Year", y = "Price")
  
  # Log transformed series
  p2 <- ggplot(data, aes(x = date, y = log_value)) +
    geom_line(color = "blue") +
    theme_minimal() +
    labs(title = paste(commodity_name, "- Log Series"),
         x = "Year", y = "Log Price")
  
  # First difference series
  p3 <- ggplot(data, aes(x = date, y = diff_value)) +
    geom_line(color = "red") +
    theme_minimal() +
    labs(title = paste(commodity_name, "- First Difference"),
         x = "Year", y = "Price Change")
  
  # Log first difference series
  p4 <- ggplot(data, aes(x = date, y = log_diff_value)) +
    geom_line(color = "purple") +
    theme_minimal() +
    labs(title = paste(commodity_name, "- Log First Difference"),
         x = "Year", y = "Log Price Change")
  
  # Arrange plots in a 2x2 grid
  grid.arrange(p1, p2, p3, p4, ncol = 2)
}


plot_transformations(coffee_trans, "Coffee")

summary_transformations <- function(data, commodity_name) {
  head_data <- head(data[, c("date", "value", "log_value", "diff_value", "log_diff_value")])
  print(paste("Summary of", commodity_name, "Transformations:"))
  print(head_data)
}

summary_transformations(coffee_trans, "Coffee")
```
```{r}
# List of commodities and their transformed data
commodities <- list(
  Coffee = coffee_trans,
  Copper = copper_trans,
  Corn = corn_trans,
  Cotton = cotton_trans,
  Lumber = lumber_trans,
  Oats = oats_trans,
  Soybean = soybean_trans,
  Wheat = wheat_trans
)

# Loop through commodities and plot transformations
for (commodity in names(commodities)) {
  plot_transformations(commodities[[commodity]], commodity)
}

```
```{r}
# Function to create ACF and PACF plots for log differenced series
plot_acf_pacf <- function(data, commodity_name) {
  # Remove NA values from log_diff_value
  clean_data <- na.omit(data[, c("date", "log_diff_value")])
  
  # Create ACF plot
  acf_plot <- ggAcf(clean_data$log_diff_value, lag.max = 36) +
    theme_minimal() +
    labs(title = paste(commodity_name, "- ACF of Log Differenced Series"),
         y = "Autocorrelation") +
    theme(plot.title = element_text(hjust = 0.5, size = 11, face = "bold"))
  
  # Create PACF plot
  pacf_plot <- ggPacf(clean_data$log_diff_value, lag.max = 36) +
    theme_minimal() +
    labs(title = paste(commodity_name, "- PACF of Log Differenced Series"),
         y = "Partial Autocorrelation") +
    theme(plot.title = element_text(hjust = 0.5, size = 11, face = "bold"))
  
  # Combine plots
  grid.arrange(acf_plot, pacf_plot, ncol = 2)
}

# List of commodities and their transformed data
commodities <- list(
  Coffee = coffee_trans,
  Copper = copper_trans,
  Corn = corn_trans,
  Cotton = cotton_trans,
  Lumber = lumber_trans,
  Oats = oats_trans,
  Soybean = soybean_trans,
  Wheat = wheat_trans
)

# Loop through commodities and create ACF/PACF plots for log differenced series
for (commodity in names(commodities)) {
  plot_acf_pacf(commodities[[commodity]], commodity)
}

# Optional: Function to create a more comprehensive analysis page for each commodity
analyze_commodity <- function(data, commodity_name) {
  par(mfrow = c(2, 2))
  
  # Clean data (remove NAs)
  clean_data <- na.omit(data[, c("date", "log_diff_value")])
  
  # Time series plot of log differenced values
  plot(clean_data$date, clean_data$log_diff_value, type = "l",
       main = paste(commodity_name, "- Log Differenced Series"),
       xlab = "Year", ylab = "Log Price Change")
  
  # ACF plot
  acf(clean_data$log_diff_value, lag.max = 36, 
      main = paste(commodity_name, "- ACF"))
  
  # PACF plot
  pacf(clean_data$log_diff_value, lag.max = 36,
       main = paste(commodity_name, "- PACF"))
  
  # Distribution of log differenced values
  hist(clean_data$log_diff_value, breaks = 30, 
       main = paste(commodity_name, "- Distribution"),
       xlab = "Log Price Change")
  
  # Reset plot layout
  par(mfrow = c(1, 1))
}
```







